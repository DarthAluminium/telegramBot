import telebot
import re

WEEK_DAYS = ('–ü–û–ù–ï–î–ï–õ–¨–ù–ò–ö', '–í–¢–û–†–ù–ò–ö', '–°–†–ï–î–ê', '–ß–ï–¢–í–ï–†–ì', '–ü–Ø–¢–ù–ò–¶–ê', '–°–£–ë–ë–û–¢–ê', '–í–û–°–ö–†–ï–°–ï–ù–¨–ï')
HASHTAG_VALIDATOR = re.compile(r"\s*(#([a-zA-Z0-9–ê-—è]+)(?:_(\w+))?)\s*$")
# [1]: –≤–µ—Å—å —Ö–µ—à—Ç–µ–≥ –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤     [2]: –ø–µ—Ä–≤–æ–µ —Å–ª–æ–≤–æ –¥–æ "_"     [3]: –≤—Å–µ —Å–ª–æ–≤–∞ –ø–æ—Å–ª–µ "_"


bot = telebot.TeleBot(BOT_TOKEN)


def format_message(text):
    lines = text.split('\n')
    day = lines[0].rstrip().lstrip()
    if day.upper() in WEEK_DAYS:
        del lines[0]
        return "üìù **{}**\n".format(day.capitalize()) + '\n'.join(['üñä ' + s for s in lines]) + '\n#—Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ'

    m = HASHTAG_VALIDATOR.match(lines[-1])
    if m is None:
        return None  # –ù–µ—á–µ–≥–æ –º–µ–Ω—è—Ç—å –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å

    if m[2].upper() == '–ù–û–í–û–°–¢–ò' and m[3] is None:
        del lines[-1]
        return "üì∞ **–ù–æ–≤–æ—Å—Ç–∏:**\n" + '\n'.join(['‚ûï ' + s for s in lines]) + '\n' + m[1]

    if m[2] == '–∞–Ω–≥–ª':
        first_name = '–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫'
    elif m[2] == '–û–ë–ñ':
        first_name = '–û–ë–ñ'
    else:
        first_name = m[2].capitalize()

    second_name = '' if m[3] is None else ' (%s)' % m[3]
    first_line = "üìì **{}{}:**\n".format(first_name, second_name)
    lines.pop()
    return first_line + '\n'.join(['üñä ' + s for s in lines]) + '\n' + m[1]


@bot.message_handler(func = lambda msg: True)
@bot.edited_message_handler()
def format_hw_msg_all(msg):
    if message.chat.type == "channel":
        f_text = format_message(msg.text)
        if f_text:
	      bot.edit_message_text(f_text, parse_mode = 'Markdown')

@bot.message_handler(commands=['start', 'help'])
def send_welcome(message):
	bot.reply_to(message, "Howdy, how are you doing?"
bot.polling()
